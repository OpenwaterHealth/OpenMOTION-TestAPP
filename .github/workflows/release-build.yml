name: Build & Release

on:
  workflow_dispatch: {}
  push:
    branches: [main, next]
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
      - "pre-[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── conda environment "omotion" ──────────────────────────────
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.12"
          activate-environment: omotion

      - name: Install dependencies into omotion
        shell: bash -el {0}
        run: |
          conda activate omotion
          python -m pip install --upgrade pip

          # Fetch latest OpenMOTION-Pylib wheel from GitHub Releases
          WHL_URL=$(python -c "
          import json, urllib.request, sys
          url = 'https://api.github.com/repos/OpenwaterHealth/OpenMOTION-Pylib/releases/latest'
          try:
              data = json.load(urllib.request.urlopen(url))
              for a in data.get('assets', []):
                  if a['name'].endswith('.whl'):
                      print(a['browser_download_url']); sys.exit(0)
          except Exception:
              pass
          sys.exit(1)
          ")

          if [ -n "$WHL_URL" ]; then
            echo "Installing pylib wheel: $WHL_URL"
            pip install "$WHL_URL"
          else
            echo "No wheel found – falling back to source install"
            pip install git+https://github.com/OpenwaterHealth/OpenMOTION-Pylib.git
          fi

          pip install -r requirements.txt

      # ── build ────────────────────────────────────────────────────
      - name: Build with PyInstaller
        shell: bash -el {0}
        run: |
          conda activate omotion
          python -m PyInstaller -y openwater.spec

      # ── package ──────────────────────────────────────────────────
      - name: Determine version tag
        id: meta
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG=$(git describe --tags --always 2>/dev/null || echo "dev-${GITHUB_SHA::8}")
          fi
          echo "TAG=${TAG}" >> "$GITHUB_OUTPUT"
          echo "ARTIFACT=OpenMOTION-TestApp-${TAG}.zip" >> "$GITHUB_OUTPUT"

          # pre-release flag
          if [[ "$TAG" == pre-* ]]; then
            echo "PRERELEASE=true" >> "$GITHUB_OUTPUT"
          else
            echo "PRERELEASE=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Zip build output
        shell: pwsh
        run: |
          Compress-Archive -Path dist\* -DestinationPath "${{ steps.meta.outputs.ARTIFACT }}"

      # ── always upload workflow artifact ──────────────────────────
      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.ARTIFACT }}
          path: dist\

      # ── create release on tag push ──────────────────────────────
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.TAG }}
          name: ${{ steps.meta.outputs.TAG }}
          generate_release_notes: true
          prerelease: ${{ steps.meta.outputs.PRERELEASE == 'true' }}
          files: ${{ steps.meta.outputs.ARTIFACT }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
